<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
    }

    .dashboard-header {
      background-color: rgba(0, 0, 0, 0.6);
      border-bottom: 2px solid #0ef;
      padding: 1.5rem;
      position: relative;
    }

    .header-content {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      text-align: center;
    }

    .dashboard-header img {
      height: 75px;
    }

    .menu-button {
      padding: 12px 0;
    }

    .info-button {
      background: none;
      border: none;
      font-size: 24px;
      color: #0ef;
      cursor: pointer;
      transition: transform 0.3s ease, color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    .info-button:hover {
      transform: scale(1.2);
      color: #00ffff;
    }

    .dropdown-menu.custom-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background-color: #1a1a1a;
      border: 1px solid #0ef;
      padding: 0.5rem 0;
      border-radius: 0.5rem;
      animation: fadeIn 0.3s ease-in-out;
      z-index: 1050;
      min-width: 200px;
    }

    .dropdown-menu.custom-dropdown.show {
      display: block;
    }

    .dropdown-item {
      color: #fff;
      padding: 0.5rem 1rem;
    }

    .dropdown-item:hover {
      background-color: #0ef;
      color: #000;
    }

    .staff-info,
    .current-semesters {
      background-color: rgba(255, 255, 255, 0.05);
      border-left: 4px solid #0ef;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .info-label {
      font-weight: bold;
      color: #0ef;
    }

    a {
      position: relative;
      display: inline-block;
      color: rgba(255, 255, 255, .4);
      font-size: 1.5em;
      letter-spacing: .1em;
      text-decoration: none;
      text-transform: uppercase;
      background: #262c37;
      padding: 10px 30px;
      transition: .5s;
      transition-delay: .8s;
    }

    a:hover {
      color: var(--clr);
      letter-spacing: 0.25em;
      text-shadow: 0 0 5px var(--clr);
      transition-delay: 1ms;
    }

    a span {
      position: absolute;
      display: block;
      background: var(--clr);
      box-shadow: 0 0 5px var(--clr);
    }

    a span:nth-child(1), a span:nth-child(2) {
      top: 0;
      height: 1.5px;
      width: 50.5%;
      transform: scaleX(0);
      transition: transform .5s;
    }

    a span:nth-child(1) { left: 0; transform-origin: left; }
    a span:nth-child(2) { right: 0; transform-origin: right; }
    a:hover span:nth-child(1) { transform: scaleX(1); transform-origin: right; }
    a:hover span:nth-child(2) { transform: scaleX(1); transform-origin: left; }

    a span:nth-child(3), a span:nth-child(4) {
      top: 0;
      width: 1.5px;
      height: 100%;
      transform: scaleY(0);
      transition: transform .5s;
      transition-delay: .4s;
    }

    a span:nth-child(3) { right: 0; transform-origin: bottom; }
    a span:nth-child(4) { left: 0; transform-origin: bottom; }
    a:hover span:nth-child(3) { transform: scaleY(1); transform-origin: top; }
    a:hover span:nth-child(4) { transform: scaleY(1); transform-origin: top; }

    a span:nth-child(5), a span:nth-child(6) {
      bottom: 0;
      height: 1.5px;
      width: 50.5%;
      transform: scaleX(0);
      transition: transform .5s;
      transition-delay: .8s;
    }

    a span:nth-child(5) { left: 0; transform-origin: right; }
    a span:nth-child(6) { right: 0; transform-origin: left; }
    a:hover span:nth-child(5) { transform: scaleX(1); transform-origin: left; }
    a:hover span:nth-child(6) { transform: scaleX(1); transform-origin: right; }

    .navbar-nav {
      flex: 1;
      text-align: center;
    }

    .navbar-brand {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <div class="header-content">
      <img src="Logo.PNG" alt="Logo" />
      <div>
        <h5>UNIVERSITY COLLEGE OF ENGINEERING NAGERCOIL</h5>
        <h6>(A Constituent College of Anna University, Chennai)</h6>
        <h6>Nagercoil - 629004</h6>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="subjectSelect" class="form-label text-white">Select Subject</label>
        <select class="form-select" id="subjectSelect">
          <option value="">All Subjects</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="monthSelect" class="form-label text-white">Select Month</label>
        <select class="form-select" id="monthSelect">
          <option value="">All Months</option>
          ${[...Array(12)].map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-3">
        <label for="yearSelect" class="form-label text-white">Select Year</label>
        <select class="form-select" id="yearSelect">
          <option value="">All Years</option>
          ${[2023, 2024, 2025].map(year => `<option value="${year}">${year}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="fetchAttendance()">Filter</button>
      </div>
    </div>

    <div class="current-semesters">
      <p><span class="info-label">Attendance Data:</span></p>
      <p id="attendance"></p>
    </div>
  </div>
<!-- Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-bottom border-secondary">
          <h5 class="modal-title" id="editModalLabel">Edit Attendance</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId" />
            <div class="mb-2">
              <label class="text-info">Date</label>
              <input type="date" id="editDate" class="form-control bg-dark text-white border-secondary" required />
            </div>
            <div class="mb-2">
              <label class="text-info">Topic</label>
              <input type="text" id="editTopic" class="form-control bg-dark text-white border-secondary" required />
            </div>
            <div class="mb-2">
              <label class="text-info">Period</label>
              <input type="number" id="editPeriod" class="form-control bg-dark text-white border-secondary" required />
            </div>
            <div class="mb-2">
              <label class="text-info">Hours</label>
              <input type="number" id="editHours" class="form-control bg-dark text-white border-secondary" required />
            </div>
            <div class="mb-2">
              <label class="text-info">Type</label>
              <select id="editType" class="form-select bg-dark text-white border-secondary" required>
                <option value="Theory">Theory</option>
                <option value="Practical">Practical</option>
                <option value="Tutorial">Tutorial</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3">Update</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const subjectSelect = document.getElementById("subjectSelect");
    const attendanceOutput = document.getElementById("attendance");

    async function fetchSubjects() {
        try {
            const res = await fetch('http://localhost:5870/api/subjects');  // Wait for the fetch to complete
            if (!res.ok) {
                alert('${res.status}');
            throw new Error(`Server error: ${res.status}`);
            }
            const subjects = await res.json();  // Wait for the response to be parsed as JSON
            subjects.forEach(sub => {
            const option = document.createElement("option");
            option.value = sub.subject_id;
            option.textContent = sub.subject_code || sub.subject_name;
            subjectSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Failed to load subjects:", error);
        }
    }
    // Attach edit button click handlers
    document.querySelectorAll(".edit-btn").forEach(button => {
      button.addEventListener("click", (e) => {
        const id = button.dataset.id;
        const record = data.find(r => r.attendance_id == id);

        if (record) {
          document.getElementById("editId").value = record.attendance_id;
          document.getElementById("editDate").value = new Date(record.date).toISOString().split("T")[0];
          document.getElementById("editTopic").value = record.topic;
          document.getElementById("editPeriod").value = record.period_number;
          document.getElementById("editHours").value = record.hour_count;
          document.getElementById("editType").value = record.type;

          const editModal = new bootstrap.Modal(document.getElementById('editModal'));
          editModal.show();
        }
      });
    });
    document.getElementById("editForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const updatedData = {
        attendance_id: document.getElementById("editId").value,
        date: document.getElementById("editDate").value,
        topic: document.getElementById("editTopic").value,
        period_number: document.getElementById("editPeriod").value,
        hour_count: document.getElementById("editHours").value,
        type: document.getElementById("editType").value
      };

      try {
        const res = await fetch("http://localhost:5870/api/updateAttendance", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(updatedData),
        });

        const result = await res.json();
        if (res.ok) {
          alert("Record updated successfully!");
          const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
          modal.hide();
          intialFetch(); // Refresh table
        } else {
          alert(result.message || "Update failed.");
        }
      } catch (err) {
        console.error("Update error:", err);
        alert("Server error");
      }
    });


    async function fetchAttendance() {
      const subject_id = subjectSelect.value;
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;

      const payload = {};
      if (subject_id) payload.subject_id = 1;
      if (month) payload.month = 4;
      if (year) payload.year = 2025;

      try {
        const res = await fetch("http://localhost:5870/api/getAttendance", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!res.ok) {
          attendanceOutput.innerHTML = `<span class="text-warning">${data.message || "No data found"}</span>`;
          return;
        }

        const rows = data.attendance.map(record => `
          <div class="mb-2">
            <strong>${record.date}</strong> | ${record.subject_code} | ${record.topic} | Period ${record.period_number} | Type: ${record.type} | Hours: ${record.hour_count}
          </div>
        `).join("");

        attendanceOutput.innerHTML = rows || "<span class='text-warning'>No records found</span>";
      } catch (err) {
        console.error("Error fetching attendance:", err);
        attendanceOutput.innerHTML = "<span class='text-danger'>Server error</span>";
      }
    }
    async function intialFetch() {
      try {
        const res = await fetch("http://localhost:5870/api/viewAttendance", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        });

        const data = await res.json();

        if (!res.ok) {
          attendanceOutput.innerHTML = `<span class="text-warning">${data.message || "No data found"}</span>`;
          return;
        }

        if (!Array.isArray(data)) {
          attendanceOutput.innerHTML = "<span class='text-warning'>Invalid data format</span>";
          return;
        }

        // Store the data globally for edit functionality
        window.attendanceData = data;

        const rows = data.map(record => {
          const date = new Date(record.date).toLocaleDateString("en-IN", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });

          return `
            <tr>
              <td>${date}</td>
              <td>${record.subject_name || 'N/A'}</td>
              <td>${record.topic || 'N/A'}</td>
              <td>${record.period_number || 'N/A'}</td>
              <td>${record.type || 'N/A'}</td>
              <td>${record.hour_count || 'N/A'}</td>
              <td>
                <button class="btn btn-sm btn-primary edit-btn" data-id="${record.attendance_id}">Edit</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${record.attendance_id}">Delete</button>
              </td>
            </tr>
          `;
        }).join("");

        attendanceOutput.innerHTML = `
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Subject</th>
                  <th>Topic</th>
                  <th>Period</th>
                  <th>Type</th>
                  <th>Hours</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;

        // Attach event listeners to edit buttons
        document.querySelectorAll(".edit-btn").forEach(button => {
          button.addEventListener("click", handleEdit);
        });

        // Attach event listeners to delete buttons
        document.querySelectorAll(".delete-btn").forEach(button => {
          button.addEventListener("click", handleDelete);
        });
      } catch (err) {
        console.error("Error fetching attendance:", err);
        attendanceOutput.innerHTML = "<span class='text-danger'>Server error</span>";
      }
    }

    // Define handleEdit function
    function handleEdit(e) {
      const id = e.target.dataset.id;
      const record = window.attendanceData.find(r => r.attendance_id == id);

      if (record) {
        document.getElementById("editId").value = record.attendance_id;
        document.getElementById("editDate").value = new Date(record.date).toISOString().split("T")[0];
        document.getElementById("editTopic").value = record.topic;
        document.getElementById("editPeriod").value = record.period_number;
        document.getElementById("editHours").value = record.hour_count;
        document.getElementById("editType").value = record.type;

        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
      } else {
        alert("Record not found for editing");
      }
    }

    // Define handleDelete function
    async function handleDelete(e) {
      const id = e.target.dataset.id;
      if (confirm('Are you sure you want to delete this attendance record?')) {
        try {
          const res = await fetch("http://localhost:5870/api/deleteAttendance", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ attendance_id: id }),
          });

          const result = await res.json();
          if (res.ok) {
            alert("Record deleted successfully!");
            intialFetch(); // Refresh table
          } else {
            alert(result.message || "Delete failed.");
          }
        } catch (err) {
          console.error("Delete error:", err);
          alert("Server error");
        }
      }
    }

    // Add table styles
    const style = document.createElement('style');
    style.textContent = `
        .table {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .table th {
            background-color: rgba(0, 0, 0, 0.3);
            color: #0ef;
        }
        .table td {
            vertical-align: middle;
        }
        .btn-sm {
            margin: 0 2px;
        }
    `;
    document.head.appendChild(style);

    // Add modal styles
    const style = document.createElement('style');
    style.textContent = `
        .modal-content {
            background-color: #1a1a1a;
            border: 1px solid #0ef;
        }
        .modal-header {
            border-bottom: 1px solid #0ef;
        }
        .form-control:focus, .form-select:focus {
            background-color: #2a2a2a;
            border-color: #0ef;
            color: #fff;
            box-shadow: 0 0 0 0.25rem rgba(0, 238, 255, 0.25);
        }
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
    `;
    document.head.appendChild(style);

    // Initial loading of subjects and attendance
    fetchSubjects();
    intialFetch();
  </script> 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

-->